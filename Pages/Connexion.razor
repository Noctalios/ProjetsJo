@page "/connexion"

@using System
@using System.Globalization
@using ProjetsJo.Entites
@using ProjetsJo.BLL.Interfaces
@using ProjetsJo.Authentication

@inject IUserService userService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider authStateProvider
@inject NavigationManager navManager

<style>
    .mud-dialog-content, .mud-dialog-title {
        background-color: #E9DDBE;
    }

    .mud-dialog-title {
        text-align: center;
    }

</style>

<PageTitle>Connexion</PageTitle>
<MudDialog>
    <DialogContent>
        <div class="logins-container">
            <div class="login-inputs">
                <label>Nom: </label>
                <input type="text" @bind="@firstName" />
                <label>Prénom :</label>
                <input type="text" @bind="@lastName" />
            </div>
            <div class="login-inputs">
                <label>
                    Mot de passe :
                    <button class="oi oi-eye" @onclick="SwitchViewPassword"></button>
                </label>
                @if (viewPassword)
                {
                    <input type="text" @bind="@password" />
                }
                else
                {
                    <input type="password" @bind="@password" />
                }
            </div>
            @if (!editingUser)
            {
                <div class="edit-inputs">
                    <div class="first-inputs">
                        <label>
                            Adresse mail :
                            <input type="text" @bind="@email">
                        </label>
                    </div>
                </div>
            }
            @if (editingUser)
            {
                <button class="editing-button" @onclick="SwitchEditingUser">Créer un compte ?</button>
            }
            else
            {
                <button class="editing-button" @onclick="SwitchEditingUser">Se connecter ?</button>
            }
        </div>
        <div class="actions-buttons">
            @if (editingUser)
            {
                <button @onclick="()=>OnLogin(firstName, lastName, password)">Se Connecter</button>
            }
            else
            {
                <button @onclick="()=>OnCreate(firstName, lastName, email, password)">Créer</button>
            }
            <button @onclick="ClosePopUp">Annuler</button>
        </div>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; }

    private string email = "";
    private string password = "";
    private string lastName = "";
    private string firstName = "";
    public User currentUser = new User();

    private bool editingUser = true;
    private bool viewPassword = false;

    protected override void OnInitialized()
    {
    }

    private void SwitchViewPassword()
    {
        viewPassword = !viewPassword;
    }

    private void SwitchEditingUser()
    {
        editingUser = !editingUser;
    }

    #region Connect

    private async Task OnLogin(string firstName, string lastName, string password)
    {
        string warningMessage = "Connexion impossible:<br>";
        if (string.IsNullOrWhiteSpace(firstName))
        {
            warningMessage += $"- Veuillez saisir votre Prénom<br>";
        }
        if (string.IsNullOrWhiteSpace(lastName))
        {
            warningMessage += $"- Veuillez saisir votre Nom<br>";
        }
        if (string.IsNullOrWhiteSpace(password))
        {
            warningMessage += $"- Veuillez saisir votre Mot de Passe<br>";
        }

        if (!string.IsNullOrWhiteSpace(lastName) && !string.IsNullOrWhiteSpace(firstName) && !string.IsNullOrWhiteSpace(password))
        {
            currentUser = userService.GetUser(firstName, lastName, password);
            if (currentUser == null)
            {
                Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopRight;
                Snackbar.Configuration.SnackbarVariant = Variant.Filled;
                Snackbar.Add($"Email ou Mot de passe invalide", Severity.Error);
            }
            else
            {
                var customAuthStateProvider = (CustomAuthenticationStateProvider)authStateProvider;
                await customAuthStateProvider.UpdateAuthenticationState(new UserSession
                    {
                        UserName = currentUser.UserName,
                        Email = currentUser.Email,
                        Role = currentUser.Role.Label,
                        Hash = password
                    });
                navManager.NavigateTo("/", true);

                MudDialog.Close(DialogResult.Ok(currentUser));
            }
        }
        else
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopRight;
            Snackbar.Configuration.SnackbarVariant = Variant.Filled;
            Snackbar.Add($"{warningMessage}", Severity.Error);
        }
    }

    private void ClosePopUp()
    {
        MudDialog.Cancel();
    }


    #endregion

    #region Edit

    private void OnCreate(string firstName, string lastName, string email, string password)
    {
        string warningMessage = "Création impossible:<br>";
        if (string.IsNullOrWhiteSpace(lastName))
        {
            warningMessage += $"- Veuillez saisir un Nom<br>";
        }
        if (string.IsNullOrWhiteSpace(firstName))
        {
            warningMessage += $"- Veuillez saisir un Prénom<br>";
        }
        if (string.IsNullOrWhiteSpace(email))
        {
            warningMessage += $"- Veuillez saisir un Email<br>";
        }
        if (string.IsNullOrWhiteSpace(password))
        {
            warningMessage += $"- Veuillez saisir un Mot de Passe<br>";
        }

        if (!string.IsNullOrWhiteSpace(email) && !string.IsNullOrWhiteSpace(password))
        {
            //userService.CreateUser(firstName, lastName, email, password);

            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopRight;
            Snackbar.Configuration.SnackbarVariant = Variant.Filled;
            Snackbar.Add($"Vous avez bien été enregistré", Severity.Success);
        }
        else
        {
            Snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopRight;
            Snackbar.Configuration.SnackbarVariant = Variant.Filled;
            Snackbar.Add($"{warningMessage}", Severity.Error);
        }
    }

    #endregion
}